{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "botIdCheck",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "POST",
          "path": "providers/Microsoft.BotService/checkNameAvailability?api-version=2018-07-12",
          "body": "[parse(concat('{\"type\":\"\", \"name\":\"', basics('botId'), '\"}'))]"
        }
      },
      {
        "name": "botId",
        "label": "Bot Id",
        "type": "Microsoft.Common.TextBox",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-zA-Z][-a-zA-Z0-9]{4,32}$"
            },
            {
              "isValid": "[equals(basics('botIdCheck').valid, true)]",
              "message": "Bot id not available"
            }
          ]
        }
      }
    ],
    "steps": [
      {
        "name": "hosting",
        "label": "Hosting choices",
        "bladeTitle": "Host bot in web app",
        "bladeSubtitle": "deploy the bot app to web app service",
        "subLabel": {
          "postValidation": "Ready to roll",
          "preValidation": "Checking all the details"
        },
        "elements": [
          {
            "name": "existingServerFarm",
            "label": "App serivce plan",
            "type": "Microsoft.Solutions.ResourceSelector",
            "resourceType": "Microsoft.Web/serverFarms",
            "options": {
              "filter": {
                "subscription": "onBasics",
                "location": "onBasics"
              }
            },
            "constraints": {
              "required": false
            }
          }
        ]
      },
      {
        "name": "overrides",
        "label": "Overrides",
        "bladeTitle": "Overrides",
        "bladeSubtitle": "provide overrides default create behavior",
        "elements": [
          {
            "name": "msAppId",
            "type": "Microsoft.Common.ServicePrincipalSelector",
            "label": {
              "sectionHeader": "Bot App registraiton",
              "principalId": "AppId",
              "password": "App secret"
            },
            "defaultValue": {
              "principalId": "",
              "name": "(new) botApp id"
            },
            "options": {
              "hideCertificate": true
            },
            "constraints": {
              "required": true,
              "validationMessage": "Password must be at least 8 characters long, contain only numbers and letters"
            }
          }
        ]
      },
      {
        "name": "qnaMakerDetails",
        "label": "QnAMaker Details",
        "bladeTitle": "QnAMaker Details",
        "bladeSubtitle": "Enter details for qnamaker deployment",
        "subLabel": {
          "postValidation": "Ready to roll",
          "preValidation": "Checking all the details"
        },
        "elements": [
          {
            "name": "zipUrl",
            "type": "Microsoft.Common.TextBox",
            "label": "zipUrl",
            "defaultValue": "",
            "toolTip": "Use only allowed characters",
            "placeholder": "",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "QnAEndpointHostName",
            "type": "Microsoft.Common.TextBox",
            "label": "QnAEndpointHostName",
            "defaultValue": "",
            "toolTip": "Use only allowed characters",
            "placeholder": "",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "QnAAuthKey",
            "type": "Microsoft.Common.TextBox",
            "label": "QnAAuthKey",
            "defaultValue": "",
            "toolTip": "Use only allowed characters",
            "placeholder": "",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "QnAKnowledgebaseId",
            "type": "Microsoft.Common.TextBox",
            "label": "QnAKnowledgebaseId",
            "defaultValue": "",
            "toolTip": "Use only allowed characters",
            "placeholder": "",
            "constraints": {
              "required": true
            }
          }
        ]
      }
    ],
    "outputs": {
      "botId": "[basics('botId')]",
      "existingServerFarmId": "[steps('hosting').existingServerFarm.id]",
      "existingServerFarmLocation": "[steps('hosting').existingServerFarm.location]",
      "msAppId": "[steps('overrides').msAppId.appId]",
      "msAppPassword": "[steps('overrides').msAppId.password]",
      "zipUrl": "[steps('qnaMakerDetails').zipUrl]",
      "QnAEndpointHostName": "[steps('qnaMakerDetails').QnAEndpointHostName]",
      "QnAAuthKey": "[steps('qnaMakerDetails').QnAAuthKey]",
      "QnAKnowledgebaseId": "[steps('qnaMakerDetails').QnAKnowledgebaseId]"
    },
    "resourceTypes": [
      "Microsoft.BotService/bots",
      "Microsoft.Web/sites",
      "Microsoft.Web/serverfarms"
    ]
  }
}
